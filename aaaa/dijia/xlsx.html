<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Excel 文件转 JSON 数组工具</title>
  <!-- 引入 Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 引入 Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- 引入 SheetJS (xlsx.js) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- 配置 Tailwind CSS -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3B82F6',
            secondary: '#10B981',
            accent: '#8B5CF6',
            neutral: '#1F2937',
            'base-100': '#FFFFFF',
            info: '#3ABFF8',
            success: '#36D399',
            warning: '#FBBD23',
            error: '#F87272',
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>

  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .transition-custom {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .card-shadow {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
  <div class="container mx-auto px-4 py-8 max-w-5xl">
    <!-- 页面标题 -->
    <header class="text-center mb-8">
      <h1 class="text-[clamp(1.8rem,3vw,2.5rem)] font-bold text-neutral mb-2">Excel 转 JSON 工具</h1>
      <p class="text-gray-600 max-w-2xl mx-auto">上传 .xlsx 或 .xls 文件，将表格数据转换为结构化 JSON 数组</p>
    </header>

    <!-- 主卡片 -->
    <div class="bg-white rounded-xl p-6 md:p-8 card-shadow transition-custom hover:shadow-lg mb-8">
      <!-- 文件上传区域 -->
      <div id="upload-area" class="mb-8">
        <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-primary transition-custom" id="drop-area">
          <i class="fa fa-cloud-upload text-5xl text-gray-400 mb-4"></i>
          <h3 class="text-xl font-semibold text-gray-700 mb-2">拖放文件到此处</h3>
          <p class="text-gray-500 mb-4">或者</p>
          <label class="inline-block bg-primary hover:bg-primary/90 text-white font-medium py-2 px-6 rounded-lg cursor-pointer transition-custom">
            <span>选择 Excel 文件</span>
            <input type="file" id="file-input" accept=".xlsx,.xls" class="hidden" />
          </label>
          <p class="text-gray-400 text-sm mt-4">支持 .xlsx 和 .xls 格式，最大文件大小：10MB</p>
        </div>
      </div>

      <!-- 转换进度条 -->
      <div id="progress-container" class="hidden mb-6">
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm font-medium text-gray-700">处理中...</span>
          <span id="progress-percentage" class="text-sm font-medium text-primary">0%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2.5">
          <div id="progress-bar" class="bg-primary h-2.5 rounded-full" style="width: 0%"></div>
        </div>
      </div>

      <!-- 转换结果区域 -->
      <div id="result-container" class="hidden">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold text-gray-700">转换结果</h3>
          <div class="flex space-x-2">
            <button id="copy-btn" class="flex items-center px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-md text-sm transition-custom">
              <i class="fa fa-copy mr-1"></i> 复制
            </button>
            <button id="download-btn" class="flex items-center px-3 py-1.5 bg-secondary hover:bg-secondary/90 text-white rounded-md text-sm transition-custom">
              <i class="fa fa-download mr-1"></i> 下载
            </button>
          </div>
        </div>
        
        <div class="bg-gray-50 rounded-lg p-4 overflow-auto max-h-[500px] border border-gray-200">
          <pre id="json-result" class="text-sm font-mono text-gray-800 whitespace-pre-wrap"></pre>
        </div>
        
        <div class="mt-4 text-sm text-gray-500">
          <p>共 <span id="row-count" class="font-semibold">0</span> 行数据</p>
        </div>
      </div>

      <!-- 错误提示区域 -->
      <div id="error-container" class="hidden mt-6 p-4 bg-red-50 border border-red-200 rounded-lg">
        <div class="flex items-start">
          <div class="flex-shrink-0 pt-0.5">
            <i class="fa fa-exclamation-circle text-red-500"></i>
          </div>
          <div class="ml-3">
            <h3 class="text-sm font-medium text-red-800">转换失败</h3>
            <div class="mt-1 text-sm text-red-700">
              <p id="error-message"></p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 页脚 -->
    <footer class="text-center text-gray-500 text-sm mt-12">
      <p>© 2025 Excel 转 JSON 工具 | 使用 SheetJS 库处理文件</p>
    </footer>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // DOM 元素
      const dropArea = document.getElementById('drop-area');
      const fileInput = document.getElementById('file-input');
      const progressContainer = document.getElementById('progress-container');
      const progressBar = document.getElementById('progress-bar');
      const progressPercentage = document.getElementById('progress-percentage');
      const resultContainer = document.getElementById('result-container');
      const jsonResult = document.getElementById('json-result');
      const rowCount = document.getElementById('row-count');
      const errorContainer = document.getElementById('error-container');
      const errorMessage = document.getElementById('error-message');
      const copyBtn = document.getElementById('copy-btn');
      const downloadBtn = document.getElementById('download-btn');

      // 拖放事件处理
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
      });

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false);
      });

      ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false);
      });

      function highlight() {
        dropArea.classList.add('border-primary', 'bg-blue-50');
      }

      function unhighlight() {
        dropArea.classList.remove('border-primary', 'bg-blue-50');
      }

      // 处理拖放文件
      dropArea.addEventListener('drop', handleDrop, false);

      function handleDrop(e) {
        const dt = e.dataTransfer;
        const file = dt.files[0];
        if (file) {
          handleFile(file);
        }
      }

      // 处理文件选择
      fileInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
          handleFile(file);
        }
      });

      // 主处理函数
      function handleFile(file) {
        // 验证文件类型和大小
        const fileSize = file.size / (1024 * 1024); // MB
        if (fileSize > 10) {
          showError('文件大小超过 10MB，请选择较小的文件');
          return;
        }

        if (!file.name.match(/\.(xlsx|xls)$/i)) {
          showError('请上传 .xlsx 或 .xls 格式的 Excel 文件');
          return;
        }

        // 显示进度条
        showProgress();
        updateProgress(10);

        // 读取文件
        const reader = new FileReader();

        reader.onprogress = function(e) {
          if (e.lengthComputable) {
            const percentComplete = Math.round((e.loaded / e.total) * 80) + 10; // 10-90%
            updateProgress(percentComplete);
          }
        };

        reader.onload = function(e) {
          try {
            updateProgress(90);
            
            // 解析 Excel 文件
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            
            // 获取第一个工作表
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            // 转换为 JSON 数组
            const jsonArray = XLSX.utils.sheet_to_json(worksheet);
            
            // 显示结果
            displayResult(jsonArray);
            updateProgress(100);
            
          } catch (error) {
            showError(`解析文件时出错: ${error.message}`);
            console.error(error);
          }
        };

        reader.onerror = function() {
          showError('读取文件时出错');
        };

        // 开始读取文件
        reader.readAsArrayBuffer(file);
      }

      // 更新进度条
      function updateProgress(percent) {
        progressBar.style.width = `${percent}%`;
        progressPercentage.textContent = `${percent}%`;
      }

      // 显示进度条
      function showProgress() {
        progressContainer.classList.remove('hidden');
        resultContainer.classList.add('hidden');
        errorContainer.classList.add('hidden');
      }

      // 显示结果
      function displayResult(jsonArray) {
        // 格式化 JSON
        const formattedJson = JSON.stringify(jsonArray, null, 2);
        
        // 更新 DOM
        jsonResult.textContent = formattedJson;
        rowCount.textContent = jsonArray.length;
        
        // 显示结果区域
        resultContainer.classList.remove('hidden');
        progressContainer.classList.add('hidden');
        
        // 添加动画效果
        setTimeout(() => {
          resultContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 100);
      }

      // 显示错误
      function showError(message) {
        errorMessage.textContent = message;
        errorContainer.classList.remove('hidden');
        progressContainer.classList.add('hidden');
        resultContainer.classList.add('hidden');
      }

      // 复制到剪贴板
      copyBtn.addEventListener('click', function() {
        const textToCopy = jsonResult.textContent;
        
        // 验证是否有内容可复制
        if (!textToCopy.trim()) {
          showError('没有可复制的内容');
          return;
        }
        
        // 尝试使用现代 Clipboard API
        if (navigator.clipboard) {
          navigator.clipboard.writeText(textToCopy)
            .then(() => {
              showCopySuccess();
            })
            .catch(err => {
              console.error('使用 Clipboard API 复制失败:', err);
              // 降级使用 execCommand
              fallbackCopyTextToClipboard(textToCopy);
            });
        } else {
          // 降级使用 execCommand
          fallbackCopyTextToClipboard(textToCopy);
        }
      });

      // 显示复制成功提示
      function showCopySuccess() {
        const originalText = copyBtn.innerHTML;
        copyBtn.innerHTML = '<i class="fa fa-check mr-1"></i> 已复制';
        copyBtn.classList.add('bg-green-100', 'text-green-700');
        
        setTimeout(() => {
          copyBtn.innerHTML = originalText;
          copyBtn.classList.remove('bg-green-100', 'text-green-700');
        }, 2000);
      }

      // 降级复制方法
      function fallbackCopyTextToClipboard(text) {
        // 创建临时 textarea 元素
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        
        try {
          // 选择文本并复制
          textarea.select();
          textarea.setSelectionRange(0, textarea.value.length);
          const successful = document.execCommand('copy');
          
          if (successful) {
            showCopySuccess();
          } else {
            throw new Error('execCommand 复制失败');
          }
        } catch (err) {
          console.error('使用 execCommand 复制失败:', err);
          showError('复制失败，请手动复制');
        } finally {
          // 移除临时元素
          document.body.removeChild(textarea);
        }
      }

      // 下载 JSON 文件
      downloadBtn.addEventListener('click', function() {
        const textToDownload = jsonResult.textContent;
        const blob = new Blob([textToDownload], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = 'excel_data.json';
        document.body.appendChild(a);
        a.click();
        
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 0);
      });
    });
  </script>
</body>
</html>