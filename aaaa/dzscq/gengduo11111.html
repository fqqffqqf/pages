<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>数据管理系统</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- 配置Tailwind主题 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        success: '#36D399',
                        warning: '#FFAB00',
                        danger: '#F56565',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .btn-hover {
                @apply transition-all duration-300 hover:shadow-lg transform hover:-translate-y-0.5;
            }
            .input-focus {
                @apply focus:ring-2 focus:ring-primary/50 focus:border-primary focus:outline-none transition-all;
            }
            .table-row-animate {
                @apply transition-all duration-200 hover:bg-primary/5;
            }
            .fade-in {
                animation: fadeIn 0.3s ease-in-out;
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .selected-row {
                animation: backgroundChange 2s ease-in-out infinite;
            }
            @keyframes backgroundChange {
                0% { background-color: rgba(56, 189, 248, 0.2); }
                50% { background-color: rgba(74, 222, 128, 0.2); }
                100% { background-color: rgba(251, 113, 133, 0.2); }
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 min-h-screen">
    <!-- 背景图 -->
    <div class="fixed inset-0 -z-10">
        <img src="../img/1.jpg" alt="背景图" class="w-full h-full object-cover opacity-10">
    </div>

    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- 页面标题 -->
        <header class="mb-8 text-center">
            <h1 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-dark mb-2">数据管理系统</h1>
            <p class="text-gray-500">高效管理和操作数据记录</p>
        </header>

        <!-- 数据提交区域 -->
        <section class="bg-white rounded-xl p-6 mb-8 card-shadow fade-in">
            <h2 class="text-xl font-semibold mb-4 text-dark flex items-center">
                <i class="fa fa-plus-circle text-primary mr-2"></i>添加新记录
            </h2>
            
            <form id="submitForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label for="a" class="block text-sm font-medium text-gray-700">ID</label>
                        <input 
                            type="text" 
                            id="a" 
                            placeholder="请输入ID" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus"
                        >
                    </div>
                    <div class="space-y-2">
                        <label for="na" class="block text-sm font-medium text-gray-700">名字</label>
                        <input 
                            type="text" 
                            id="na" 
                            placeholder="请输入名字" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus"
                        >
                    </div>
                    <div class="space-y-2">
                        <label for="b" class="block text-sm font-medium text-gray-700">地址</label>
                        <input 
                            type="text" 
                            id="b" 
                            placeholder="请输入地址" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus"
                        >
                    </div>
                    <div class="space-y-2">
                        <label for="c1" class="block text-sm font-medium text-gray-700">代码</label>
                        <input 
                            type="text" 
                            id="c1" 
                            placeholder="请输入代码" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus"
                        >
                    </div>
                </div>
                
                <!-- 隐藏字段 -->
                <input type="text" value="1" id="d1" class="hidden">
                <input type="text" value="1" id="e" class="hidden">
                <input type="text" value="1" id="f" class="hidden">
                
                <div class="pt-2">
                    <button 
                        type="button" 
                        onclick="insertServlet()" 
                        class="px-6 py-2 bg-primary text-white rounded-lg btn-hover flex items-center"
                    >
                        <i class="fa fa-save mr-2"></i>提交记录
                    </button>
                </div>
            </form>
        </section>

        <!-- 表格显示区域 -->
        <section class="bg-white rounded-xl p-6 mb-8 card-shadow fade-in">
            <h2 class="text-xl font-semibold mb-4 text-dark flex items-center">
                <i class="fa fa-table text-primary mr-2"></i>数据记录列表
            </h2>
            
            <div class="overflow-x-auto">
                <table id="tab" class="w-full min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <!-- 表格头部将动态添加 -->
                    </thead>
                    <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
                        <!-- 表格内容将动态添加 -->
                    </tbody>
                </table>
            </div>
            
            <!-- 空状态提示 -->
            <div id="emptyState" class="py-12 text-center hidden">
                <i class="fa fa-folder-open-o text-4xl text-gray-300 mb-4"></i>
                <p class="text-gray-500">暂无数据记录</p>
                <p id="emptyStateReason" class="text-gray-400 text-sm mt-2">可能没有符合条件的数据</p>
            </div>
            
            <!-- 加载状态 -->
            <div id="loadingState" class="py-12 text-center">
                <div class="animate-spin h-8 w-8 border-2 border-primary border-t-transparent rounded-full mx-auto mb-4"></div>
                <p class="text-gray-500">正在加载数据...</p>
            </div>
        </section>

        <!-- 底部图片 -->
        <section class="mb-8 rounded-xl overflow-hidden card-shadow fade-in">
            <img src="../img/5.jpg" alt="底部图片" class="w-full h-auto object-cover">
        </section>
    </div>

    <!-- 消息提示框 -->
    <div id="message" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-dark text-white px-6 py-4 rounded-lg shadow-xl z-50 opacity-0 transition-opacity duration-300 flex items-center">
        <i class="fa fa-info-circle mr-2"></i>
        <span id="messageContent"></span>
    </div>

    <!-- 编辑弹窗 -->
    <div id="editPopup" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden fade-in">
        <div class="bg-white rounded-xl max-w-md w-full mx-4 overflow-hidden card-shadow">
            <div class="p-5 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                <h3 class="text-lg font-semibold text-dark flex items-center">
                    <i class="fa fa-edit text-primary mr-2"></i>修改内容
                </h3>
                <button onclick="closeEditPopup()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="p-5 space-y-4">
                <div class="space-y-2">
                    <label for="editId" class="block text-sm font-medium text-gray-700">ID</label>
                    <input 
                        type="text" 
                        id="editId" 
                        placeholder="Id" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus"
                    >
                </div>
                <div class="space-y-2">
                    <label for="editName" class="block text-sm font-medium text-gray-700">名字</label>
                    <input 
                        type="text" 
                        id="editName" 
                        placeholder="名字" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus"
                    >
                </div>
                <div class="space-y-2">
                    <label for="editDz" class="block text-sm font-medium text-gray-700">地址</label>
                    <input 
                        type="text" 
                        id="editDz" 
                        placeholder="地址" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus"
                    >
                </div>
                <div class="space-y-2">
                    <label for="editDm" class="block text-sm font-medium text-gray-700">代码</label>
                    <input 
                        type="text" 
                        id="editDm" 
                        placeholder="代码" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus"
                    >
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <div class="space-y-2">
                        <label for="editYc" class="block text-xs font-medium text-gray-700">显示</label>
                        <input 
                            type="text" 
                            id="editYc" 
                            placeholder="显示" 
                            class="w-full px-3 py-1.5 border border-gray-300 rounded-lg input-focus text-sm"
                        >
                    </div>
                    <div class="space-y-2">
                        <label for="editFalt" class="block text-xs font-medium text-gray-700">绑定</label>
                        <input 
                            type="text" 
                            id="editFalt" 
                            placeholder="绑定" 
                            class="w-full px-3 py-1.5 border border-gray-300 rounded-lg input-focus text-sm"
                        >
                    </div>
                    <div class="space-y-2">
                        <label for="editSx" class="block text-xs font-medium text-gray-700">失效</label>
                        <input 
                            type="text" 
                            id="editSx" 
                            placeholder="失效" 
                            class="w-full px-3 py-1.5 border border-gray-300 rounded-lg input-focus text-sm"
                        >
                    </div>
                </div>
                <input type="hidden" id="oldId">
            </div>
            <div class="p-4 border-t border-gray-200 flex justify-end gap-3 bg-gray-50">
                <button 
                    onclick="saveEdit()" 
                    class="px-4 py-2 bg-primary text-white rounded-lg btn-hover flex items-center hidden"
                >
                    <i class="fa fa-save mr-1"></i>保存修改
                </button>
                <button 
                    onclick="closeEditPopup()" 
                    class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg btn-hover flex items-center"
                >
                    <i class="fa fa-times mr-1"></i>取消
                </button>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let longPressTimer;

        // 页面加载时获取数据
        window.onload = function () {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('emptyStateReason').textContent = '';
            
            console.log('开始加载数据...');
            fetch('/aaaa/FindDzscqServlet')
                .then(response => {
                    console.log('响应状态:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP错误，状态码: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('获取到原始数据:', data);
                    showData(data);
                    document.getElementById('loadingState').classList.add('hidden');
                    
                    // 检查数据是否为空或被过滤
                    const validData = data.filter(item => 
                        item.yc === "1" && item.falt === "1" && item.sx === "1"
                    );
                    
                    if (data.length === 0) {
                        document.getElementById('emptyState').classList.remove('hidden');
                        document.getElementById('emptyStateReason').textContent = '服务器返回空数据';
                    } else if (validData.length === 0) {
                        document.getElementById('emptyState').classList.remove('hidden');
                        document.getElementById('emptyStateReason').textContent = '所有数据都被过滤（显示/绑定/失效条件不满足）';
                    }
                })
                .catch(error => {
                    console.error('数据加载错误:', error);
                    document.getElementById('loadingState').classList.add('hidden');
                    document.getElementById('emptyState').classList.remove('hidden');
                    document.getElementById('emptyStateReason').textContent = `加载失败: ${error.message}`;
                    showMessage('数据加载失败: ' + error.message, 'error');
                });
        }

        // 提交数据
        function insertServlet() {
            let password = prompt("请输入密码"); 

            if (password !== null) {
                if (password === "duan") {  
                    var id = document.getElementById("a").value;
                    var name = document.getElementById("na").value;
                    var dz = document.getElementById("b").value;
                    var dm = document.getElementById("c1").value;
                    var yc = document.getElementById("d1").value;
                    var falt = document.getElementById("e").value;
                    var sx = document.getElementById("f").value;

                    // 验证必填字段
                    if (!id || !name || !dz || !dm) {
                        showMessage('请填写完整的必填字段', 'warning');
                        return;
                    }

                    // 创建参数对象
                    const params = new URLSearchParams({
                        id,
                        dz,
                        dm,
                        yc,
                        falt,
                        sx,
                        name
                    });

                    // 显示加载状态
                    const submitBtn = document.querySelector('button[onclick="insertServlet()"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>提交中...';

                    fetch(`/aaaa/InsertDzscqServlet?&${params.toString()}`)
                        .then(response => response.json())
                        .then(data => {
                            showMessage(data.message || '提交成功');
                            window.onload();
                            // 重置表单
                            document.getElementById('submitForm').reset();
                        })
                        .catch(error => {
                            console.error('提交错误:', error);
                            showMessage('提交失败，请重试', 'error');
                        })
                        .finally(() => {
                            // 恢复按钮状态
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalText;
                        });
                } else {
                    // 密码错误处理
                    let confirmError = confirm("输入错误，请重新输入密码");  
                    if (confirmError) {
                        insertServlet(); // 重新调用函数
                    }
                }
            }
        }

        // 删除数据
        function delByIdFzServlet() {
            var id = document.getElementById("c").value;
            var password = document.getElementById("d").value;
            
            if (!id || !password) {
                showMessage('请填写ID和密码', 'warning');
                return;
            }

            if (confirm(`确定要删除ID为 ${id} 的记录吗？`)) {
                fetch(`/aaaa/delByIdDzscqServlet?id=${id}&password=${password}`)
                    .then(response => response.json())
                    .then(data => {
                        showMessage(data.message);
                        window.onload();
                    })
                    .catch(error => {
                        console.error('删除错误:', error);
                        showMessage('删除失败，请重试', 'error');
                    });
            }
        }

        // 显示数据表格 - 重点修复区域
        function showData(data) {
            const table = document.getElementById('tab');
            const tableBody = document.getElementById('tableBody');
            
            // 清空表格
            table.innerHTML = "";
            tableBody.innerHTML = "";

            // 检查数据是否有效
            if (!Array.isArray(data)) {
                console.error('数据格式错误，期望数组但得到:', typeof data);
                showMessage('数据格式错误，无法显示', 'error');
                return;
            }

            if (data.length === 0) {
                return; // 空状态在调用处处理
            }

            // 检查数据结构
            const firstItem = data[0];
            if (!firstItem || typeof firstItem !== 'object') {
                console.error('数据项格式错误，期望对象但得到:', typeof firstItem);
                showMessage('数据项格式错误，无法显示', 'error');
                return;
            }

            // 创建表头
            const thead = table.createTHead();
            const headerRow = thead.insertRow();
            headerRow.className = "bg-gray-50";
            
            // 获取表头字段
            const headers = Object.keys(firstItem);
            console.log('数据字段:', headers);
            
            headers.forEach(header => {
                const th = document.createElement('th');
                th.className = "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider";
                
                // 根据字段设置表头显示文本
                let headerText = header;
                switch(header) {
                    case 'id': headerText = 'ID'; break;
                    case 'name': headerText = '名字'; break;
                    case 'dz': headerText = '地址'; break;
                    case 'dm': headerText = '代码'; break;
                    case 'yc': headerText = '显示'; break;
                    case 'falt': headerText = '绑定'; break;
                    case 'sx': headerText = '失效'; break;
                }
                
                th.textContent = headerText;
                headerRow.appendChild(th);
            });

            // 添加操作列表头
            const actionTh = document.createElement('th');
            actionTh.className = "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider";
            actionTh.textContent = '操作';
            headerRow.appendChild(actionTh);

            // 创建表格内容
            let displayedCount = 0;
            data.forEach((item, index) => {
                try {
                    // 检查过滤条件 - 这可能是数据不显示的主要原因
                    const isVisible = item.yc === "1" && item.falt === "1" && item.sx === "1";
                    console.log(`数据项 ${index} 可见性:`, isVisible, '条件:', {yc: item.yc, falt: item.falt, sx: item.sx});
                    
                    if (isVisible) {
                        displayedCount++;
                        const row = tableBody.insertRow();
                        row.dataset.id = item.id;
                        row.className = "table-row-animate";

                        // 添加单元格内容
                        headers.forEach(header => {
                            const cell = row.insertCell();
                            cell.className = "px-4 py-3 whitespace-nowrap text-sm text-gray-700";
                            
                            // 处理长文本，添加省略号
                            if (header === 'dz' || header === 'dm') {
                                cell.innerHTML = `<div class="max-w-xs truncate" title="${item[header] || ''}">${item[header] || ''}</div>`;
                            } else {
                                cell.textContent = item[header] || '';
                            }
                        });

                        // 添加操作列
                        const actionCell = row.insertCell();
                        actionCell.className = "px-4 py-3 whitespace-nowrap text-sm font-medium";
                        actionCell.innerHTML = `
                            <button 
                                onmousedown="startLongPress(this, '${item.id}')" 
                                onmouseup="endLongPress()" 
                                onmouseout="endLongPress()" 
                                ontouchstart="startLongPress(this, '${item.id}')" 
                                ontouchend="endLongPress()" 
                                ontouchmove="endLongPress()" 
                                onclick="copyToClipboard('${(item['dz'] || '') + (item['dm'] || '')}')"
                                class="text-primary hover:text-primary/80 transition-colors flex items-center"
                            >
                                <i class="fa fa-copy mr-1"></i>复制
                            </button>
                        `;
                    }
                } catch (error) {
                    console.error(`处理数据项 ${index} 时出错:`, error, '数据项:', item);
                }
            });

            console.log(`数据处理完成 - 总条数: ${data.length}, 显示条数: ${displayedCount}`);

            // 为表格行添加鼠标悬停事件
            tableBody.addEventListener('mouseover', function(event) {
                let target = event.target;
                while (target && target.tagName !== 'TR') {
                    target = target.parentNode;
                }
                if (target) {
                    const rows = tableBody.getElementsByTagName('tr');
                    for (let i = 0; i < rows.length; i++) {
                        rows[i].classList.remove('selected-row');
                    }
                    target.classList.add('selected-row');
                }
            });

            tableBody.addEventListener('mouseout', function(event) {
                let target = event.target;
                while (target && target.tagName !== 'TR') {
                    target = target.parentNode;
                }
                if (target) {
                    target.classList.remove('selected-row');
                }
            });
        }

        // 搜索功能
        function f() {
            var elementById = document.getElementById("id2")?.value || '';
            g(elementById);
        }

        function g(guanjianzhi) {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            
            fetch(`/aaaa/MohuchaxunServlet?tiaojian=${encodeURIComponent(guanjianzhi)}`)
                .then(response => response.json())
                .then(data => {
                    console.log('搜索结果:', data);
                    showData(data);
                    document.getElementById('loadingState').classList.add('hidden');
                    if (data.length === 0) {
                        document.getElementById('emptyState').classList.remove('hidden');
                        document.getElementById('emptyStateReason').textContent = '未找到匹配的数据';
                        showMessage('未找到匹配的数据');
                    }
                })
                .catch(error => {
                    console.error('搜索错误:', error);
                    document.getElementById('loadingState').classList.add('hidden');
                    document.getElementById('emptyState').classList.remove('hidden');
                    document.getElementById('emptyStateReason').textContent = `搜索失败: ${error.message}`;
                    showMessage('搜索失败，请重试', 'error');
                });
        }

        // 复制到剪贴板
        function copyToClipboard(text) {
            // 现代浏览器剪贴板API
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text)
                    .then(() => {
                        showMessage('复制成功: ' + text.substring(0, 20) + (text.length > 20 ? '...' : ''));
                    })
                    .catch(err => {
                        console.error('复制失败:', err);
                        fallbackCopyText(text);
                    });
            } else {
                fallbackCopyText(text);
            }
        }

        // 复制功能降级方案
        function fallbackCopyText(text) {
            const tempInput = document.createElement('input');
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showMessage('复制成功: ' + text.substring(0, 20) + (text.length > 20 ? '...' : ''));
                } else {
                    showMessage('复制失败，请手动复制', 'error');
                }
            } catch (err) {
                console.error('Fallback复制失败:', err);
                showMessage('复制失败，请手动复制', 'error');
            } finally {
                document.body.removeChild(tempInput);
            }
        }

        // 显示消息提示
        function showMessage(content, type = 'success') {
            const messageBox = document.getElementById('message');
            const messageContent = document.getElementById('messageContent');
            const icon = messageBox.querySelector('i');
            
            // 设置消息内容
            messageContent.textContent = content;
            
            // 设置消息类型样式
            messageBox.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 px-6 py-4 rounded-lg shadow-xl z-50 opacity-100 transition-opacity duration-300 flex items-center';
            
            switch(type) {
                case 'success':
                    messageBox.classList.add('bg-success', 'text-white');
                    icon.className = 'fa fa-check-circle mr-2';
                    break;
                case 'error':
                    messageBox.classList.add('bg-danger', 'text-white');
                    icon.className = 'fa fa-exclamation-circle mr-2';
                    break;
                case 'warning':
                    messageBox.classList.add('bg-warning', 'text-white');
                    icon.className = 'fa fa-exclamation-triangle mr-2';
                    break;
                default:
                    messageBox.classList.add('bg-dark', 'text-white');
                    icon.className = 'fa fa-info-circle mr-2';
            }
            
            // 3秒后隐藏消息
            setTimeout(() => {
                messageBox.classList.add('opacity-0');
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 300);
            }, 3000);
        }

        // 长按事件处理
        function startLongPress(button, id) {
            longPressTimer = setTimeout(() => {
                openEditPopup(id);
            }, 1000);
        }

        function endLongPress() {
            clearTimeout(longPressTimer);
        }

        // 打开编辑弹窗
        function openEditPopup(id) {
            const row = document.querySelector(`tr[data-id="${id}"]`);
            if (!row) {
                console.warn(`未找到ID为 ${id} 的行`);
                return;
            }

            // 填充编辑表单
            document.getElementById('editId').value = id;
            document.getElementById('oldId').value = id;
            document.getElementById('editName').value = row.cells[1].textContent || '';
            document.getElementById('editDz').value = row.cells[2].textContent || '';
            document.getElementById('editDm').value = row.cells[3].textContent || '';
            document.getElementById('editYc').value = row.cells[4].textContent || '';
            document.getElementById('editFalt').value = row.cells[5].textContent || '';
            document.getElementById('editSx').value = row.cells[6].textContent || '';

            // 显示编辑弹窗和保存按钮
            document.getElementById('editPopup').style.display = 'flex';
            document.querySelector('button[onclick="saveEdit()"]').classList.remove('hidden');
        }

        // 关闭编辑弹窗
        function closeEditPopup() {
            document.getElementById('editPopup').style.display = 'none';
        }

        // 保存编辑内容
        function saveEdit() {
            let id = document.getElementById('editId').value;
            let name = document.getElementById('editName').value;
            let dz = document.getElementById('editDz').value;
            let dm = document.getElementById('editDm').value;
            let yc = document.getElementById('editYc').value;
            let falt = document.getElementById('editFalt').value;
            let sx = document.getElementById('editSx').value;
            let oldId = document.getElementById('oldId').value;

            // 验证必填字段
            if (!id || !name || !dz || !dm) {
                showMessage('请填写完整的必填字段', 'warning');
                return;
            }

            const params = new URLSearchParams({
                id,
                dz,
                dm,
                yc,
                falt,
                sx,
                name,
                oldId
            });

            // 显示加载状态
            const saveBtn = document.querySelector('button[onclick="saveEdit()"]');
            const originalText = saveBtn.innerHTML;
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-1"></i>保存中...';

            fetch(`/aaaa/UpdateDzscqServlet?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    showMessage(data.message || '修改成功');
                    closeEditPopup();
                    window.onload();
                })
                .catch(error => {
                    console.error('修改错误:', error);
                    showMessage('修改失败，请重试', 'error');
                })
                .finally(() => {
                    // 恢复按钮状态
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = originalText;
                });
        }

        // 防止表单默认提交
        document.getElementById('submitForm').addEventListener('submit', function(e) {
            e.preventDefault();
        });
    </script>
</body>
</html>
