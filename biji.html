<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ç¬”è®°ç®±</title>
	<script src="aaaa/js/ss.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input[type="text"], textarea, input[type="file"] {
            width: calc(100% - 22px); /* Account for padding/border */
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #45a049;
        }
        .note-item {
            border: 1px solid #eee;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            background-color: #fafafa;
        }
        .note-title {
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
            margin-bottom: 8px;
        }
        .note-content {
            color: #666;
            margin-bottom: 10px;
            word-wrap: break-word;
        }
        .note-image {
            max-width: 100%;
            height: auto;
            margin-top: 10px;
            border-radius: 4px;
        }
        .note-date {
            font-size: 0.85em;
            color: #999;
            margin-bottom: 10px;
        }
        .copy-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .copy-btn:hover {
            background-color: #0056b3;
        }
        .delete-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 5px;
        }
        .delete-btn:hover {
            background-color: #c82333;
        }
        .actions {
            margin-top: 10px;
        }
        .loading {
            text-align: center;
            color: #666;
        }
        .error {
            color: red;
            margin-top: 10px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“ æˆ‘çš„ç¬”è®°ç®±</h1>
    <form id="noteForm">
        <div class="form-group">
            <label for="noteTitle">æ ‡é¢˜ (å¯é€‰)</label>
            <input type="text" id="noteTitle" placeholder="è¾“å…¥ç¬”è®°æ ‡é¢˜...">
        </div>
        <div class="form-group">
            <label for="noteContent">æ–‡æœ¬å†…å®¹</label>
            <textarea id="noteContent" placeholder="è¾“å…¥è¦ä¿å­˜çš„æ–‡æœ¬..."></textarea>
        </div>
        <div class="form-group">
            <label for="noteImage">å›¾ç‰‡ (å¯é€‰)</label>
            <input type="file" id="noteImage" accept="image/*">
        </div>
        <button type="submit">ğŸ’¾ ä¿å­˜ç¬”è®°</button>
    </form>

    <div id="errorDiv" class="error" style="display:none;"></div>

    <h2>ğŸ“‹ ç¬”è®°åˆ—è¡¨</h2>
    <div id="notesList" class="loading">åŠ è½½ä¸­...</div>
</div>


<script>
   
    const SUPABASE_URL = 'https://yjbnqdrnoetgmmrtkszo.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_5z0BoTQwqPwWGaOetcVf0g_UknvjY9B';

    if (!SUPABASE_URL || !SUPABASE_ANON_KEY || SUPABASE_URL.includes('your-project-id')) {
        alert('è¯·å…ˆåœ¨ä»£ç ä¸­å¡«å…¥ä½ çš„ Supabase é¡¹ç›® URL å’Œ Anon Keyï¼');
        console.error('Supabase credentials are missing or incorrect.');
        document.getElementById('notesList').textContent = 'é”™è¯¯ï¼šè¯·é…ç½® Supabase ä¿¡æ¯ã€‚';
        throw new Error('Supabase credentials are missing or incorrect.');
    }

    const supabase1 = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- 2. DOM Elements ---
    const noteForm = document.getElementById('noteForm');
    const noteTitleInput = document.getElementById('noteTitle');
    const noteContentInput = document.getElementById('noteContent');
    const noteImageInput = document.getElementById('noteImage');
    const notesListDiv = document.getElementById('notesList');
    const errorDiv = document.getElementById('errorDiv');

    // --- 3. Form Submission Handler ---
    noteForm.addEventListener('submit', async (e) => {
        e.preventDefault(); // é˜»æ­¢è¡¨å•é»˜è®¤æäº¤

        const title = noteTitleInput.value.trim();
        const content = noteContentInput.value.trim();
        const imageFile = noteImageInput.files[0];

        if (!content && !imageFile) {
            showError('è¯·è¾“å…¥æ–‡æœ¬å†…å®¹æˆ–é€‰æ‹©ä¸€å¼ å›¾ç‰‡ã€‚');
            return;
        }

        try {
            let imageUrl = null;
            if (imageFile) {
                // --- ä¸Šä¼ å›¾ç‰‡åˆ° Storage ---
                const fileName = `${Date.now()}_${imageFile.name}`;
				// è·å–å¯¹åº”çš„ Content-Type
            const contentType = getContentType(imageFile.name);
			console.log(contentType)
			 //const uploadimageFile=new Blob([imageFile],{type:contentType});
			
                const { data: uploadData, error: uploadError } = await supabase1
                    .storage
                    .from('notes-images') // å­˜å‚¨æ¡¶åç§°
                    .upload(fileName, fileName, {
                        cacheControl: '3600',
                        upsert: false , // å¦‚æœæ–‡ä»¶å·²å­˜åœ¨åˆ™æŠ¥é”™
						contentType: contentType // è®¾ç½® Content-Type
                    });

                if (uploadError) {
                    throw uploadError;
                }
                // è·å–å…¬å¼€ URL
                const { data: publicUrlData } = supabase1
                    .storage
                    .from('notes-images')
                    .getPublicUrl(fileName);

                imageUrl = publicUrlData.publicUrl;
            }

            // --- æ’å…¥æ•°æ®åˆ° 'notes' è¡¨ ---
            const { error: insertError } = await supabase1
                .from('notes')
                .insert([
                    { title: title || 'æ— æ ‡é¢˜ç¬”è®°', content: content, image_url: imageUrl }
                ]);

            if (insertError) {
                throw insertError;
            }

            // æ¸…ç©ºè¡¨å•
            noteForm.reset();
            hideError();
            loadNotes(); // é‡æ–°åŠ è½½åˆ—è¡¨

        } catch (error) {
            console.error('ä¿å­˜ç¬”è®°å¤±è´¥:', error);
            showError(`ä¿å­˜å¤±è´¥: ${error.message}`);
        }
    });

    // --- 4. Load Notes Function ---
    async function loadNotes() {
        try {
            const { data: notes, error } = await supabase1
                .from('notes')
                .select('*')
                .order('inserted_at', { ascending: false }); // æŒ‰æ—¶é—´å€’åºæ’åˆ—

            if (error) {
                throw error;
            }

            renderNotes(notes);
        } catch (error) {
            console.error('åŠ è½½ç¬”è®°å¤±è´¥:', error);
            notesListDiv.innerHTML = `<p class="error">åŠ è½½ç¬”è®°å¤±è´¥: ${error.message}</p>`;
        }
    }

    // --- 5. Render Notes Function ---
    function renderNotes(notes) {
        if (!notes || notes.length === 0) {
            notesListDiv.innerHTML = '<p>æš‚æ— ç¬”è®°ã€‚</p>';
            return;
        }

        notesListDiv.innerHTML = notes.map(note => `
            <div class="note-item">
                <div class="note-title">${escapeHtml(note.title)}</div>
                <div class="note-content">${escapeHtml(note.content || '')}</div>
                ${note.image_url ? `<img src="${note.image_url}" alt="Note Image" class="note-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"><div style="display:none;">å›¾ç‰‡åŠ è½½å¤±è´¥</div>` : ''}
                <div class="note-date">${new Date(note.inserted_at).toLocaleString()}</div>
                <div class="actions">
                    <button class="copy-btn" onclick="copyText('${escapeHtmlForJs(note.content || '')}')">ğŸ“‹ å¤åˆ¶æ–‡æœ¬</button>
                    ${note.image_url ? `<button class="copy-btn" onclick="copyText('${note.image_url}')">ğŸ”— å¤åˆ¶å›¾ç‰‡é“¾æ¥</button>` : ''}
                    <button class="delete-btn" onclick="deleteNote(${note.id})">ğŸ—‘ï¸ åˆ é™¤</button>
                </div>
            </div>
        `).join('');
    }

    // --- 6. Copy Text Function ---
    function copyText(text) {
        if (!text) return;
        navigator.clipboard.writeText(text).then(() => {
            alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
        }).catch(err => {
            console.error('å¤åˆ¶å¤±è´¥', err);
            // Fallback for older browsers if needed
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼ï¼ˆä½¿ç”¨å¤‡ç”¨æ–¹æ³•ï¼‰');
        });
    }

    // --- 7. Delete Note Function ---
    async function deleteNote(noteId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç¬”è®°å—ï¼Ÿ')) return;

        try {
            const noteToDelete = document.querySelector(`.note-item:has(.delete-btn[onclick="deleteNote(${noteId})"])`);
            
            // å¦‚æœæœ‰å›¾ç‰‡ï¼Œå°è¯•åˆ é™¤ Storage ä¸­çš„æ–‡ä»¶
            const imageElement = noteToDelete.querySelector('.note-image');
            if (imageElement && imageElement.src) {
                const publicUrl = imageElement.src;
                // æå–æ–‡ä»¶å (ä» URL ä¸­çš„æœ€åä¸€éƒ¨åˆ†)
                const pathParts = new URL(publicUrl).pathname.split('/');
                const fileName = pathParts[pathParts.length - 1];
                
                const { error: deleteFileError } = await supabase1
                    .storage
                    .from('notes-images')
                    .remove([fileName]);

                if (deleteFileError) {
                    console.warn('åˆ é™¤å›¾ç‰‡æ–‡ä»¶å¤±è´¥:', deleteFileError.message); // éè‡´å‘½é”™è¯¯
                }
            }

            // åˆ é™¤æ•°æ®åº“ä¸­çš„è®°å½•
            const { error: deleteError } = await supabase1
                .from('notes')
                .delete()
                .eq('id', noteId);

            if (deleteError) {
                throw deleteError;
            }

            // æˆåŠŸåï¼Œé‡æ–°åŠ è½½åˆ—è¡¨
            loadNotes();

        } catch (error) {
            console.error('åˆ é™¤ç¬”è®°å¤±è´¥:', error);
            showError(`åˆ é™¤å¤±è´¥: ${error.message}`);
        }
    }


    // --- 8. Helper Functions ---
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    function escapeHtmlForJs(str) {
        return str.replace(/'/g, "\\'").replace(/"/g, '&quot;');
    }

    function showError(message) {
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
    }

    function hideError() {
        errorDiv.style.display = 'none';
    }
	
	// --- è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®æ–‡ä»¶åæ¨æ–­ Content-Type ---
function getContentType(fileName) {
    const extension = fileName.toLowerCase().split('.').pop();
    const mimeTypes = {
        // å›¾ç‰‡
        'jpg': 'image/jpeg',
        'jpeg': 'image/jpeg',
        'png': 'image/png',
        'gif': 'image/gif',
		'html':'text/html',
        'webp': 'image/webp',
        'svg': 'image/svg+xml',
        'bmp': 'image/bmp',
        'ico': 'image/x-icon',
        'tiff': 'image/tiff',
        'tif': 'image/tiff',
        'pdf': 'application/pdf',
        'txt': 'text/plain',
        'json': 'application/json',
        'zip': 'application/zip',
        'doc': 'application/msword',
        'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'xls': 'application/vnd.ms-excel',
        'xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
		// å…¶ä»–å¸¸è§ç±»å‹ (æŒ‰éœ€æ·»åŠ )
    };
    return mimeTypes[extension] || 'application/octet-stream'; // é»˜è®¤ç±»å‹
}

    // --- 9. Initial Load ---
    document.addEventListener('DOMContentLoaded', () => {
        loadNotes();
    });
</script>

</body>

</html>

